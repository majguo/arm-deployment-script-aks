{
    "$schema": "https://schema.management.azure.com/schemas/0.1.2-preview/CreateUIDefinition.MultiVm.json#",
    "handler": "Microsoft.Azure.CreateUIDef",
    "version": "0.1.2-preview",
    "parameters": {
        "basics": [
            {
                "name": "identityId",
                "type": "Microsoft.Common.TextBox",
                "label": "User Assigned Managed Identity",
                "toolTip": "Input the id of User Assigned Managed Identity.",
                "constraints": {
                    "required": true,
                    "regex": "^[a-z0-9A-Z\\-\\.\\/]+$",
                    "validationMessage": "The user assigned managed identity ID should be a valid Azure resource ID. Example: /subscriptions/{subscriptionId}/resourceGroups/{resourceGroupName}/providers/{resourceProviderNamespace}/{resourceType}/{resourceName}"
                }
            }
        ],
        "steps": [
            {
                "name": "AKSCluster",
                "label": "Configure AKS cluster",
                "subLabel": {
                    "preValidation": "Provide required info for AKS cluster configuration",
                    "postValidation": "Done"
                },
                "bladeTitle": "Configure AKS cluster",
                "elements": [
                    {
                        "name": "createAKSCluster",
                        "type": "Microsoft.Common.OptionsGroup",
                        "label": "Create a new AKS cluster?",
                        "defaultValue": "Yes",
                        "toolTip": "Select 'Yes' to create a new AKS cluster, or select 'No' to provide an existing AKS cluster.",
                        "constraints": {
                            "allowedValues": [
                                {
                                    "label": "Yes",
                                    "value": "true"
                                },
                                {
                                    "label": "No",
                                    "value": "false"
                                }
                            ],
                            "required": true
                        }
                    },
                    {
                        "name": "servicePrincipal",
                        "type": "Microsoft.Common.Section",
                        "label": "Provide a Service Principal to create an AKS cluster",
                        "elements": [
                            {
                                "name": "spClientId",
                                "type": "Microsoft.Common.TextBox",
                                "label": "Service principal client ID",
                                "toolTip": "The client ID of an existing service principal.",
                                "constraints": {
                                    "required": true,
                                    "regex": "^[0-9A-Fa-f]{8}[-][0-9A-Fa-f]{4}[-][0-9A-Fa-f]{4}[-][0-9A-Fa-f]{4}[-][0-9A-Fa-f]{12}$",
                                    "validationMessage": "The service principal Id should be a valid global unique identifier (GUID). Example: 00000000-0000-0000-0000-000000000000"
                                }
                            },
                            {
                                "name": "spClientSecret",
                                "type": "Microsoft.Common.PasswordBox",
                                "label": {
                                    "password": "Service principal client secret",
                                    "confirmPassword": "Confirm client secret"
                                },
                                "toolTip": "The client secret of an existing service principal.",
                                "constraints": {
                                    "required": true
                                }
                            }
                        ],
                        "visible": "[bool(steps('AKSCluster').createAKSCluster)]"
                    },
                    {
                        "name": "clusterInfo",
                        "type": "Microsoft.Common.Section",
                        "label": "Provide information for an existing AKS cluster",
                        "elements": [
                            {
                                "name": "aksClusterName",
                                "type": "Microsoft.Common.TextBox",
                                "label": "Cluster name",
                                "toolTip": "Use only allowed characters.",
                                "constraints": {
                                    "required": true,
                                    "regex": "^[a-z0-9A-Z\\-]+$",
                                    "validationMessage": "The value must only contain letters and numbers."
                                }
                            },
                            {
                                "name": "aksClusterRGName",
                                "type": "Microsoft.Common.TextBox",
                                "label": "Resource group name of the cluster",
                                "toolTip": "Use only allowed characters.",
                                "constraints": {
                                    "required": true,
                                    "regex": "^[a-z0-9A-Z\\-]+$",
                                    "validationMessage": "The value must only contain letters and numbers."
                                }
                            }
                        ],
                        "visible": "[not(bool(steps('AKSCluster').createAKSCluster))]"
                    }
                ]
            },
            {
                "name": "ACRInstance",
                "label": "Configure ACR instance",
                "subLabel": {
                    "preValidation": "Provide required info for ACR instance configuration",
                    "postValidation": "Done"
                },
                "bladeTitle": "Configure ACR instance",
                "elements": [
                    {
                        "name": "createACR",
                        "type": "Microsoft.Common.OptionsGroup",
                        "label": "Create a new ACR instance?",
                        "defaultValue": "Yes",
                        "toolTip": "Select 'Yes' to create a new ACR instance, or select 'No' to provide an existing ACR instance.",
                        "constraints": {
                            "allowedValues": [
                                {
                                    "label": "Yes",
                                    "value": "true"
                                },
                                {
                                    "label": "No",
                                    "value": "false"
                                }
                            ],
                            "required": true
                        }
                    },
                    {
                        "name": "acrInfo",
                        "type": "Microsoft.Common.Section",
                        "label": "Provide information for an existing ACR instance",
                        "elements": [
                            {
                                "name": "acrName",
                                "type": "Microsoft.Common.TextBox",
                                "label": "Registry name",
                                "toolTip": "Use only allowed characters.",
                                "constraints": {
                                    "required": true,
                                    "regex": "^[a-z0-9A-Z\\-]+$",
                                    "validationMessage": "The value must only contain letters and numbers."
                                }
                            }
                        ],
                        "visible": "[not(bool(steps('ACRInstance').createACR))]"
                    }
                ]
            },
            {
                "name": "Application",
                "label": "Configure Java EE Application",
                "subLabel": {
                    "preValidation": "Provide required info for application",
                    "postValidation": "Done"
                },
                "bladeTitle": "Configure Java EE Application",
                "elements": [
                    {
                        "name": "appPackageUrl",
                        "type": "Microsoft.Common.FileUpload",
                        "label": "Application package (.war)",
                        "toolTip": "The application war package to deploy.",
                        "constraints": {
                            "required": true
                        },
                        "options": {
                            "multiple": false,
                            "uploadMode": "url",
                            "openMode": "binary"
                        }
                    },
                    {
                        "name": "appReplicas",
                        "type": "Microsoft.Common.TextBox",
                        "label": "Number of application replicas",
                        "defaultValue": "2",
                        "toolTip": "The number of application replicas to deploy.",
                        "constraints": {
                            "required": true,
                            "regex": "^(1|2|3|4|5)$",
                            "validationMessage": "Number of application replicas to deploy, limit 1-5."
                        }
                    }
                ]
            }
        ],
        "outputs": {
            "location": "[location()]",
            "identityId": "[basics('identityId')]",
            "createAKSCluster": "[bool(steps('AKSCluster').createAKSCluster)]",
            "spClientId": "[steps('AKSCluster').servicePrincipal.spClientId]",
            "spClientSecret": "[steps('AKSCluster').servicePrincipal.spClientSecret]",
            "aksClusterName": "[steps('AKSCluster').clusterInfo.aksClusterName]",
            "aksClusterRGName": "[steps('AKSCluster').clusterInfo.aksClusterRGName]",
            "createACR": "[bool(steps('ACRInstance').createACR)]",
            "acrName": "[steps('ACRInstance').acrInfo.acrName]",
            "appPackageUrl": "[steps('Application').appPackageUrl]",
            "appReplicas": "[int(steps('Application').appReplicas)]"
        }
    }
}
